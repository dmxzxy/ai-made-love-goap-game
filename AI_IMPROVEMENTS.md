# AI系统优化文档

## 概述
本次更新大幅改进了单位的战斗AI，使其更加智能和响应迅速。

## 主要改进

### 1. 移动受阻检测系统
**问题**：单位在移动过程中可能被地形或其他单位阻挡，导致无法到达目标。

**解决方案**：
- 每0.5秒检测一次位置变化
- 如果连续3次检测到移动距离 < 5像素（共1.5秒），认为单位卡住
- 自动触发目标重新评估，寻找新的可到达目标

**代码位置**：`entities/agent.lua` 行375-400

```lua
-- 卡住检测：每0.5秒检查一次位置
self.stuckCheckTimer = self.stuckCheckTimer + dt
if self.stuckCheckTimer >= 0.5 then
    local moveDist = math.sqrt(dx * dx + dy * dy)
    if self.target and moveDist < 5 and not self.isAttacking then
        self.consecutiveStuckChecks = self.consecutiveStuckChecks + 1
        if self.consecutiveStuckChecks >= 3 then
            -- 卡住了，重新选择目标
            self:reevaluateTarget()
        end
    end
end
```

### 2. 增强的攻击反应系统
**问题**：单位被攻击时反应不够迅速，容易被动挨打。

**原有机制**：
- 只在没有目标时反击
- 反击窗口2秒

**改进方案**：
- 反击窗口延长到3秒
- **即使有当前目标，如果攻击者距离更近80px以上，也会立即切换**
- 攻击者优先级分数从+100提高到+180

**代码位置**：`entities/agent.lua` 行402-430

```lua
-- 即使有目标，如果攻击者更近，也切换目标
if dist < currentDist - 80 then
    self.target = self.lastAttacker
    self.currentPlan = nil
    print("Switching to closer attacker!")
end
```

### 3. 更频繁的目标重新评估
**问题**：目标评估间隔太长（1.5秒），错过近距离威胁。

**改进**：
- 评估间隔从1.5秒缩短到0.8秒
- 更快响应战场变化

**代码位置**：`entities/agent.lua` 行432-437

### 4. 优化的距离优先级算法
**问题**：距离因素权重不够，导致单位不够"灵活"。

**改进**：
- 距离分数权重从2.5x提高到3.5x
- **新增极近目标加成**：
  - 100px内：+150分
  - 200px内：+80分
- 当前目标粘性从60降低到40，减少切换阻力

**代码位置**：`entities/agent.lua` 行610-625

```lua
-- 1. 距离因素 - 大幅提高权重
local distScore = 1000 / (dist + 10)
score = score + distScore * 3.5  -- 从2.5提高到3.5

-- 2. 极近目标加成
if dist < 100 then
    score = score + 150  -- 非常近的目标高优先级
elseif dist < 200 then
    score = score + 80   -- 较近的目标中等加成
end
```

## 优先级权重总结

### 单位目标评估（从高到低）
1. **距离因素**：基础分数 `1000/(dist+10) * 3.5`
2. **极近加成**：100px内 +150，200px内 +80
3. **攻击者加成**：+180（大幅提高）
4. **治疗单位**：+100
5. **残血目标**：HP<30% +80，HP<50% +40
6. **狙击手**：+70
7. **当前目标粘性**：+40（降低）
8. **高威胁敌人**：攻击力>20 +50
9. **矿工**：+30

### 防御塔目标评估
- 距离分数权重：2.0x
- 射程内的塔：+150
- 残血塔：HP<30% +120
- 整体优先级：0.7x（低于敌军）

### 基地目标评估
- 基础分数极低：`200/(dist+100)`
- 附近有敌军/塔时：0.3x惩罚
- 只在清场后才攻击

## 实际效果

### 场景1：被围攻
- **优化前**：单位锁定远处目标，被近距离敌人围殴
- **优化后**：立即切换到近距离攻击者，优先自保

### 场景2：追击敌人
- **优化前**：单位追击途中被卡住，持续尝试无效路径
- **优化后**：1.5秒后检测到卡住，自动寻找新目标

### 场景3：战场混战
- **优化前**：目标切换不够灵活，容易被包围
- **优化后**：每0.8秒评估一次，快速响应战场变化

## 调试信息

系统会在以下情况输出调试信息：

```
[TeamA Soldier] Stuck detected! Switching target...
[TeamB Sniper] Counter-attacking attacker!
[TeamA Tank] Switching to closer attacker! (120 < 280)
[TeamB Scout] Target switch: Healer (dist:85 score:234.5)
```

## 参数调整建议

如果需要进一步调整AI行为：

### 让单位更"固执"（不易切换目标）
- 增加当前目标粘性：40 → 80
- 降低距离权重：3.5 → 2.5
- 增加目标评估间隔：0.8秒 → 1.5秒

### 让单位更"灵活"（频繁切换目标）
- 减少当前目标粘性：40 → 20
- 增加距离权重：3.5 → 5.0
- 缩短目标评估间隔：0.8秒 → 0.5秒

### 让单位更"谨慎"（优先自保）
- 增加攻击者加成：180 → 250
- 增加极近目标加成：150 → 200

## 性能影响

- 目标评估频率提高：1.5秒 → 0.8秒（+87.5%计算量）
- 新增卡住检测：每0.5秒（轻量级计算）
- 整体性能影响：可忽略（< 1% CPU）

## 后续优化方向

1. **团队协作**：识别盟友正在攻击的目标，优先集火
2. **地形感知**：识别狭窄通道，避免拥堵
3. **撤退机制**：低血量时智能后撤到安全位置
4. **预测性移动**：预判敌人移动轨迹，提前拦截

---
*最后更新：2024*
*相关文件：entities/agent.lua*
