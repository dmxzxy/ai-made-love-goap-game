# 🆕 2024年11月26日更新

## 主要改进

### 1. 完整的建筑碰撞检测系统 🏗️

**问题**：防御塔、建筑物、资源点会重叠

**解决方案**：
- ✅ 建筑与建筑：最小间距 buildingSize + 30
- ✅ 建筑与防御塔：最小间距 buildingSize + 50  
- ✅ 建筑与资源点：最小间距 buildingSize + 70
- ✅ 塔与塔：最小间距 60
- ✅ 塔与建筑：最小间距 50
- ✅ 塔与资源：最小间距 60

**关键改进**：
- 50次尝试寻找合适位置
- 找不到位置时**不建造**、**不扣资源**
- 显示清晰的失败原因

**效果对比**：
```
优化前 ❌：
🏭 🏭    建筑重叠
  💎     资源点被压住
🗼       防御塔挤在一起

优化后 ✅：
🏭    🏭   建筑分散
   💎       资源点清晰可见
 🗼   🗼    防御塔合理间距
```

---

### 2. Buff建筑数量限制 ⚖️

**规则**：Support类建筑每队最多**2个**

**受限建筑**：
- 💚 FieldHospital (治疗光环)
- 🔧 TradingPost (矿工速度+60%)

**实现效果**：
- ✅ 建造前检查数量
- ✅ 超过限制时拒绝建造
- ✅ 显示警告：`⚠️ Support building limit reached! Max 2`
- ✅ 不扣除资源

**示例场景**：
```
红队建筑：
- FieldHospital (1/2)  ✅ 成功
- TradingPost (2/2)    ✅ 成功
- 尝试建造第3个       ❌ "Support building limit reached!"
```

---

### 3. 移动中攻击机制 ⚔️

**功能**：单位移动时自动攻击范围内的敌人

**实现逻辑**：
```lua
移动时每帧检查：
1. 冷却时间结束？       ✓
2. 攻击范围内有敌人？   ✓
3. 选择最近的敌人       ✓
4. 执行攻击             ✓
5. 继续移动（不打断）   ✓
```

**关键特性**：
- ✅ **不打断移动**：攻击后继续向目标移动
- ✅ **遵守冷却**：按照单位攻击速度冷却
- ✅ **自动选择**：攻击范围内最近的敌人
- ✅ **完整效果**：伤害数字、粒子效果、仇恨记录

**实战效果**：
```
优化前 ❌：
单位A → → → 目标
       ↓
    敌人B (在范围内但不攻击)
       ↓
单位A继续移动，错过敌人B

优化后 ✅：
单位A → → → 目标
       ↓
    敌人B 💥 攻击！
       ↓
单位A继续移动，同时已造成伤害
```

**应用场景**：
- `actions/move_to_enemy.lua` - 移动到敌人时
- `actions/move_to_base.lua` - 移动到基地时

---

### 4. 改进的错误提示 📢

**新增提示信息**：

**资源不足**：
```
[RED] Not enough resources for Gold Mine! Need $150, have $120
```

**位置不足**：
```
[BLUE] ⚠️ Cannot build Infantry Factory - no valid position found (territory full or too crowded)
```

**数量限制**：
```
[GREEN] ⚠️ Support building limit reached! Max 2 support buildings allowed. Current: 2
```

**防御塔失败**：
```
[RED] ⚠️ Cannot build tower - no valid position found (territory full or too crowded)
```

---

## 技术细节

### 碰撞检测流程

```lua
function findBuildingPosition(base, buildingSize, existingBuildings)
    -- 最多尝试50次
    for attempt = 1, 50 do
        -- 1. 随机位置
        local x, y = randomInTerritory(base, 300)
        
        -- 2. 检查建筑
        for _, building in ipairs(existingBuildings) do
            if distance(x, y, building) < minDistance then
                overlaps = true
            end
        end
        
        -- 3. 检查防御塔
        for _, tower in ipairs(towers) do
            if distance(x, y, tower) < minDistance then
                overlaps = true
            end
        end
        
        -- 4. 检查资源点
        for _, resource in ipairs(resources) do
            if distance(x, y, resource) < minDistance then
                overlaps = true
            end
        end
        
        -- 5. 成功
        if not overlaps then
            return x, y, true
        end
    end
    
    -- 6. 失败
    return nil, nil, false
end
```

### Support建筑限制检测

```lua
function tryBuildSpecialBuilding(base, buildingType)
    local config = SpecialBuilding.types[buildingType]
    
    -- 检查Support类建筑数量
    if config.category == "support" then
        local supportCount = 0
        for _, building in ipairs(specialBuildings) do
            if building.team == base.team 
               and building.category == "support" 
               and not building.isDead then
                supportCount = supportCount + 1
            end
        end
        
        if supportCount >= 2 then
            print("⚠️ Support building limit reached! Max 2")
            return  -- 不建造
        end
    end
    
    -- ... 继续建造逻辑
end
```

### 移动中攻击实现

```lua
function MoveToEnemy:perform(agent, dt)
    -- ... 移动逻辑 ...
    
    -- 移动中攻击
    if agent.attackCooldown <= 0 then
        local closestEnemy = nil
        local closestDist = math.huge
        
        -- 查找范围内最近的敌人
        for _, enemy in ipairs(agent.enemies) do
            if not enemy.isDead and enemy.health > 0 then
                local dist = distance(agent, enemy)
                if dist <= agent.attackRange and dist < closestDist then
                    closestEnemy = enemy
                    closestDist = dist
                end
            end
        end
        
        -- 执行攻击
        if closestEnemy then
            attack(agent, closestEnemy)
            agent.attackCooldown = 1 / agent.attackSpeed
        end
    end
    
    -- 继续移动
    move(agent, dt)
end
```

---

## 配置参数

### 间距参数（可调整）

```lua
-- 建筑放置
local minDistanceBuilding = buildingSize + 30  -- 建筑间距
local minDistanceTower = buildingSize + 50     -- 与塔间距
local minDistanceResource = buildingSize + 70  -- 与资源间距

-- 防御塔放置
local minDistanceTower = 60       -- 塔之间
local minDistanceBuilding = 50    -- 塔与建筑
local minDistanceResource = 60    -- 塔与资源
```

### Support建筑限制（可调整）

```lua
-- 当前：最多2个
if supportCount >= 2 then

-- 调整建议：
-- 更严格：1个
-- 更宽松：3个或4个
-- 无限制：注释掉整段代码
```

### 建造尝试次数（可调整）

```lua
-- 当前：50次尝试
local maxAttempts = 50

-- 调整建议：
-- 更多尝试（更容易成功）：100
-- 更少尝试（更快失败）：30
```

---

## 测试建议

### 测试1：密集建造
```
1. 连续建造10+建筑
2. 观察是否重叠
3. 观察资源点是否清晰

预期：✅ 所有建筑分散，无重叠
```

### 测试2：Support限制
```
1. 建造FieldHospital
2. 建造TradingPost
3. 尝试建造第3个Support建筑

预期：❌ 第3个失败，显示警告
```

### 测试3：移动中攻击
```
1. 让单位A移动到远处
2. 让敌人B挡在路径上
3. 观察是否攻击

预期：✅ 攻击B后继续移动
```

### 测试4：领地满载
```
1. 建造15+建筑填满领地
2. 尝试再建造
3. 观察提示信息

预期：❌ 显示"territory full"
```

---

## 性能影响

- **碰撞检测**：只在建造时执行，< 1ms
- **Support检测**：只在建造时执行，可忽略
- **移动攻击**：每帧执行，但有冷却限制，< 2% CPU

---

## 相关文件

- `main.lua` - 建筑碰撞检测、Support限制
- `entities/base.lua` - 防御塔碰撞检测
- `actions/move_to_enemy.lua` - 移动中攻击
- `actions/move_to_base.lua` - 移动中攻击

---

*更新时间：2024年11月26日*
*版本：v1.3.0*
